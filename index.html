<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protocolos de Solubilização Microbiana - LAMAG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- MathJax for nice formulas -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fafaf9; /* Stone-50 */
            color: #44403c; /* Stone-700 */
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 700px; 
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 400px;
            background: white;
            border-radius: 0.5rem;
            padding: 1rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d6d3d1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a8a29e; }

        .active-nav {
            background-color: #e7e5e4;
            border-left: 4px solid #d97706; 
            font-weight: 600;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* Modal Transitions */
        .modal {
            transition: opacity 0.25s ease;
        }
        body.modal-active {
            overflow-x: hidden;
            overflow-y: visible !important;
        }
    </style>
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
</head>
<body class="bg-stone-50 h-screen overflow-hidden flex flex-col md:flex-row">

    <!-- Sidebar Navigation -->
    <aside class="w-full md:w-64 bg-white border-r border-stone-200 flex flex-col z-20 shadow-md md:h-full shrink-0">
        <div class="p-6 border-b border-stone-100 flex flex-col items-center">
            
            <!-- LOGO DO LABORATÓRIO (AUTO-FIX) -->
            <!-- Tenta carregar logo.png, se falhar tenta logo.jpg, se falhar esconde a imagem e mostra o texto -->
            <div class="w-full flex justify-center mb-4 relative group">
                <img src="logo.png" 
                     onerror="this.onerror=null; this.src='logo.jpg'; document.getElementById('backup-title').classList.remove('hidden');"
                     alt="LAMAG Logo" 
                     class="max-h-28 w-auto object-contain rounded-sm transition-opacity duration-300">
            </div>

            <!-- Título de Texto (Aparece se a imagem falhar) -->
            <div id="backup-title" class="hidden text-center animate-fade-in">
                <h1 class="text-2xl font-bold text-stone-800 flex items-center justify-center gap-2">
                    <span class="text-amber-600">&#9763;</span> LAMAG
                </h1>
            </div>
            
            <p class="text-[10px] text-stone-500 mt-2 text-center uppercase tracking-wider font-semibold">Protocolos Oficiais</p>
        </div>
        
        <nav class="flex-1 overflow-y-auto py-4 space-y-1">
            <button onclick="switchTab('dashboard')" id="nav-dashboard" class="w-full text-left px-6 py-3 text-stone-600 hover:bg-stone-50 transition-colors active-nav">
                <span class="mr-2">&#8862;</span> Visão Geral
            </button>
            <button onclick="switchTab('micro')" id="nav-micro" class="w-full text-left px-6 py-3 text-stone-600 hover:bg-stone-50 transition-colors">
                <span class="mr-2">&#9737;</span> Microbiologia (In Vitro)
            </button>
            <button onclick="switchTab('colorim')" id="nav-colorim" class="w-full text-left px-6 py-3 text-stone-600 hover:bg-stone-50 transition-colors">
                <span class="mr-2 text-stone-400 grayscale opacity-80">&#9879;</span> Testes Analíticos
            </button>
            <button onclick="switchTab('bio')" id="nav-bio" class="w-full text-left px-6 py-3 text-stone-600 hover:bg-stone-50 transition-colors">
                <span class="mr-2">&#9873;</span> Bioquímica (Quant)
            </button>
            <button onclick="switchTab('mol')" id="nav-mol" class="w-full text-left px-6 py-3 text-stone-600 hover:bg-stone-50 transition-colors">
                <span class="mr-2">&#9900;</span> Biologia Molecular
            </button>
        </nav>

        <!-- Resources Button -->
        <div class="px-6 pb-2">
            <button onclick="toggleModal()" class="w-full py-2 px-4 bg-stone-800 text-stone-100 rounded-lg text-xs font-semibold hover:bg-stone-900 transition flex items-center justify-center gap-2 shadow-sm">
                <span>&#128230;</span> Materiais Essenciais
            </button>
        </div>

        <!-- Credits Footer -->
        <div class="p-4 border-t border-stone-200 bg-stone-50 text-center">
            <p class="text-[10px] text-stone-500 leading-tight">
                Elaborado por <span class="font-bold text-stone-600">Amanda Hecktheuer</span> - Assistente de pesquisa NS e <span class="font-bold text-stone-600">Adriane Costa dos Santos</span> - Bolsista DTI-A FAPESC
            </p>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="flex-1 overflow-y-auto p-4 md:p-8 relative custom-scrollbar" id="main-content">
        
        <!-- HEADER -->
        <header class="mb-8 border-b border-stone-200 pb-4">
            <h2 class="text-2xl font-bold text-stone-800" id="page-title">Fluxo de Pesquisa</h2>
            <p class="text-stone-500 max-w-3xl text-sm" id="page-desc">
                Este painel consolida protocolos padronizados para isolamento e caracterização de microrganismos solubilizadores de minerais (Fosfato, Potássio, Cálcio e Magnésio) visando biofertilizantes.
            </p>
        </header>

        <!-- 1. DASHBOARD SECTION -->
        <div id="dashboard" class="content-section space-y-8 animate-fade-in">
             <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Concept Card (UPDATED FLOW) -->
                <div class="bg-white p-6 rounded-lg shadow-sm border border-stone-200">
                    <h3 class="text-lg font-semibold text-stone-800 mb-4 border-b pb-2">O Ciclo de Triagem</h3>
                    <p class="text-sm text-stone-600 mb-4">
                        A seleção de microrganismos eficientes segue um funil de triagem otimizado em 3 etapas principais.
                    </p>
                    <!-- CSS Flowchart (UPDATED) -->
                    <div class="flex flex-col gap-2 items-center text-sm">
                        <div class="w-full p-3 bg-stone-100 border border-stone-300 rounded text-center font-semibold text-stone-700">Amostragem de Solo/Rizosfera</div>
                        <div class="text-stone-400 font-bold">&#8595;</div>
                        
                        <div class="w-full p-3 bg-green-50 border border-green-200 text-green-800 rounded text-center shadow-sm">
                            <span class="font-bold block">1. Meios Seletivos Sólidos</span>
                            <span class="text-xs">(Visualização de Halo)</span>
                        </div>
                        <div class="text-stone-400 font-bold">&#8595;</div>
                        
                        <div class="w-full p-3 bg-amber-50 border border-amber-200 text-amber-800 rounded text-center shadow-sm">
                            <span class="font-bold block">2. Testes Analíticos & Ensaio Líquido</span>
                            <span class="text-xs">(Quantificação Bioquímica)</span>
                        </div>
                        <div class="text-stone-400 font-bold">&#8595;</div>
                        
                        <div class="w-full p-3 bg-blue-50 border border-blue-200 text-blue-800 rounded text-center shadow-sm">
                            <span class="font-bold block">3. Identificação Molecular</span>
                            <span class="text-xs">(16S/ITS e Primers Específicos)</span>
                        </div>
                    </div>
                </div>

                <!-- Mechanisms Chart -->
                <div class="bg-white p-6 rounded-lg shadow-sm border border-stone-200 flex flex-col">
                    <h3 class="text-lg font-semibold text-stone-800 mb-2">Mecanismos Principais</h3>
                    <p class="text-sm text-stone-500 mb-4">Distribuição típica da ação microbiana na solubilização.</p>
                    <div class="flex-1 flex items-center justify-center">
                        <div class="chart-container">
                            <canvas id="mechanismsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Key Targets Grid -->
            <h3 class="text-lg font-semibold text-stone-800 mt-6">Nutrientes Alvo e Fontes Insolúveis</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-white p-4 rounded border-t-4 border-blue-500 shadow-sm">
                    <div class="font-bold text-lg text-stone-800">Fósforo (P)</div>
                    <div class="text-xs text-stone-500 mt-1">Fontes Insolúveis:</div>
                    <ul class="text-sm mt-2 list-disc list-inside text-stone-600"><li>Fosfato Tricálcico</li><li>Fosfato de Ferro</li><li>Fosfato de Alumínio</li></ul>
                </div>
                <div class="bg-white p-4 rounded border-t-4 border-purple-500 shadow-sm">
                    <div class="font-bold text-lg text-stone-800">Potássio (K)</div>
                    <div class="text-xs text-stone-500 mt-1">Fontes Insolúveis:</div>
                    <ul class="text-sm mt-2 list-disc list-inside text-stone-600"><li>Feldspato</li><li>Mica (Muscovita)</li><li>Ilita</li></ul>
                </div>
                <div class="bg-white p-4 rounded border-t-4 border-orange-500 shadow-sm">
                    <div class="font-bold text-lg text-stone-800">Cálcio (Ca)</div>
                    <div class="text-xs text-stone-500 mt-1">Fontes Insolúveis:</div>
                    <ul class="text-sm mt-2 list-disc list-inside text-stone-600"><li>Carbonato de Cálcio</li><li>Dolomita</li></ul>
                </div>
                <div class="bg-white p-4 rounded border-t-4 border-gray-500 shadow-sm">
                    <div class="font-bold text-lg text-stone-800">Magnésio (Mg)</div>
                    <div class="text-xs text-stone-500 mt-1">Fontes Insolúveis:</div>
                    <ul class="text-sm mt-2 list-disc list-inside text-stone-600"><li>Carbonato de Magnésio</li><li>Silicatos de Mg</li></ul>
                </div>
            </div>
        </div>

        <!-- 2. MICROBIOLOGY SECTION -->
        <div id="micro" class="content-section hidden space-y-6 animate-fade-in">
            <!-- Intro Card -->
            <div class="bg-amber-50 border-l-4 border-amber-500 p-4 rounded shadow-sm">
                <h3 class="font-bold text-amber-800">Protocolo de Fase Sólida (Triagem)</h3>
                <p class="text-sm text-amber-700 mt-1">
                    O objetivo desta fase é a detecção qualitativa e semi-quantitativa através da formação de halos de solubilização em meios de cultura sólidos.
                </p>
            </div>

            <!-- Troubleshooting Warning -->
            <div class="bg-red-50 border border-red-100 p-4 rounded-lg flex gap-3 items-start">
                <div class="text-red-500 text-xl">&#9888;</div>
                <div>
                    <h4 class="text-sm font-bold text-red-800">Atenção: Falsos Positivos</h4>
                    <p class="text-xs text-red-700 mt-1">
                        Cuidado com a interpretação de halos em meios contendo <strong>ácidos orgânicos</strong> ou agentes quelantes (como EDTA). Um halo claro pode ser causado apenas pela acidificação do meio sem a liberação real do íon. A confirmação quantitativa em meio líquido é <strong>obrigatória</strong>.
                    </p>
                </div>
            </div>

            <!-- CALCULATOR SECTION -->
            <div class="bg-white rounded-lg shadow-sm border border-stone-200 overflow-hidden">
                <div class="bg-stone-100 px-6 py-4 border-b border-stone-200 flex justify-between items-center">
                    <h3 class="font-bold text-stone-800 flex items-center">
                        <span class="mr-2 text-xl">&#128207;</span> Ferramenta de Cálculo de IS (Índice de Solubilização)
                    </h3>
                    <span class="text-xs text-stone-500 bg-white px-2 py-1 rounded border border-stone-200 font-mono">Ref: Edi-Premono et al. (1996)</span>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2">
                    <!-- Left: Inputs & Formula -->
                    <div class="p-6 border-r border-stone-100 flex flex-col justify-between">
                        <div>
                            <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-100">
                                <h4 class="text-sm font-bold text-blue-900 mb-2">A Base do Cálculo</h4>
                                <div class="text-center bg-white p-3 rounded border border-blue-100 shadow-sm text-blue-900 font-serif mb-2">
                                    $$ IS = \frac{\text{Diâmetro Total do Halo (mm)}}{\text{Diâmetro da Colônia (mm)}} $$
                                </div>
                            </div>

                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold text-stone-700 mb-1">Diâmetro da Colônia (C)</label>
                                    <div class="flex items-center">
                                        <input type="number" id="colonyDiam" class="w-full p-2 text-sm border border-stone-300 rounded focus:ring-2 focus:ring-amber-500 outline-none" placeholder="Ex: 5" value="10" oninput="updatePetriViz()">
                                        <span class="ml-2 text-stone-500 text-sm">mm</span>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-stone-700 mb-1">Diâmetro do Halo Total (H)</label>
                                    <div class="flex items-center">
                                        <input type="number" id="haloDiam" class="w-full p-2 text-sm border border-stone-300 rounded focus:ring-2 focus:ring-amber-500 outline-none" placeholder="Ex: 15" value="25" oninput="updatePetriViz()">
                                        <span class="ml-2 text-stone-500 text-sm">mm</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="siResultBox" class="mt-6 p-4 rounded-lg bg-stone-50 text-center border border-stone-200 transition-colors">
                            <span class="text-sm text-stone-500 uppercase tracking-wider font-bold">Resultado</span>
                            <div class="text-3xl font-bold text-stone-800 my-1" id="siValue">--</div>
                            <div class="text-sm font-medium" id="siClass">Preencha os dados</div>
                        </div>
                    </div>

                    <!-- Right: Visualization (Canvas) -->
                    <div class="p-6 bg-stone-50 flex flex-col items-center justify-center">
                        <h4 class="text-xs font-bold text-stone-400 uppercase mb-4 w-full text-center">Ilustração da Medida</h4>
                        <div class="relative">
                            <canvas id="petriCanvas" width="300" height="300" class="rounded-full shadow-lg bg-white border-4 border-stone-200"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="flex gap-2 flex-wrap mt-8">
                <button onclick="filterMedia('P')" class="px-4 py-2 bg-white border border-stone-300 rounded hover:bg-stone-50 text-sm font-semibold focus:ring-2 ring-amber-500 transition">Fósforo (P)</button>
                <button onclick="filterMedia('K')" class="px-4 py-2 bg-white border border-stone-300 rounded hover:bg-stone-50 text-sm font-semibold focus:ring-2 ring-amber-500 transition">Potássio (K)</button>
                <button onclick="filterMedia('CaMg')" class="px-4 py-2 bg-white border border-stone-300 rounded hover:bg-stone-50 text-sm font-semibold focus:ring-2 ring-amber-500 transition">Ca & Mg</button>
            </div>

            <div id="media-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Cards injected by JS -->
            </div>
        </div>

        <!-- 3. ANALYTICAL/COLORIMETRIC SECTION -->
        <div id="colorim" class="content-section hidden space-y-8 animate-fade-in">
             <div class="bg-purple-50 border-l-4 border-purple-500 p-4 rounded shadow-sm">
                <h3 class="font-bold text-purple-800">Triagem Rápida & Métodos Analíticos</h3>
                <p class="text-sm text-purple-700 mt-1">
                    Combinação de métodos qualitativos e quantitativos padrão.
                </p>
            </div>

            <!-- Acidification Indicators -->
            <div>
                <h3 class="text-lg font-bold text-stone-800 mb-4 flex items-center">
                    1. Detecção de Acidólise (Produção de Ácidos Orgânicos)
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Bromothymol Blue Card -->
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-stone-200">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-bold text-stone-700">Azul de Bromotimol</h4>
                            <span class="text-xs bg-stone-100 px-2 py-1 rounded">pH 6.0 - 7.6</span>
                        </div>
                        <p class="text-sm text-stone-600 mb-4">O indicador mais utilizado.</p>
                        <div class="space-y-2">
                            <div class="flex justify-between text-xs font-bold text-stone-500"><span>Ácido (+)</span><span>Neutro</span><span>Básico</span></div>
                            <div class="h-8 rounded w-full bg-gradient-to-r from-yellow-400 via-green-400 to-blue-600 shadow-inner border border-stone-200"></div>
                            <div class="flex justify-between text-xs text-stone-400"><span>Amarelo (< 6.0)</span><span>Verde</span><span>Azul (> 7.6)</span></div>
                        </div>
                        <div class="mt-4 bg-stone-50 p-3 rounded text-xs text-stone-600 border border-stone-100">
                            <strong>Preparo:</strong> Solução estoque 1% em Etanol. Usar 5 mL/L de meio. <br>
                            <span class="text-[10px] text-stone-400 italic">Ref: Cunningham, J. E., & Kuiack, C. (1992).</span>
                        </div>
                    </div>

                    <!-- Bromocresol Purple Card -->
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-stone-200">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-bold text-stone-700">Púrpura de Bromocresol</h4>
                            <span class="text-xs bg-stone-100 px-2 py-1 rounded">pH 5.2 - 6.8</span>
                        </div>
                        <p class="text-sm text-stone-600 mb-4">Mais sensível para microplacas.</p>
                        <div class="space-y-2">
                            <div class="flex justify-between text-xs font-bold text-stone-500"><span>Ácido (+)</span><span>Neutro</span></div>
                            <div class="h-8 rounded w-full bg-gradient-to-r from-yellow-400 via-yellow-200 to-purple-600 shadow-inner border border-stone-200"></div>
                            <div class="flex justify-between text-xs text-stone-400"><span>Amarelo (< 5.2)</span><span>Roxo (> 6.8)</span></div>
                        </div>
                        <div class="mt-4 bg-stone-50 p-3 rounded text-xs text-stone-600 border border-stone-100">
                            <strong>Interpretação:</strong> O halo amarelo ao redor da colônia em fundo roxo indica forte produção de ácido.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enzymatic Tests (RESTORED VISUALIZATION) -->
            <div>
                <h3 class="text-lg font-bold text-stone-800 mb-4 flex items-center">
                    2. Detecção de Fosfatases (Mineralização)
                </h3>
                <div class="bg-white p-6 rounded-lg shadow-sm border border-stone-200">
                    <div class="flex flex-col md:flex-row gap-6">
                        <div class="flex-1">
                            <h4 class="font-bold text-stone-700 mb-2">Ensaio de p-NPP (p-Nitrofenilfosfato)</h4>
                            <p class="text-sm text-stone-600 mb-4">
                                Detecta a presença de fosfatases ácidas ou alcalinas. Estas enzimas quebram ligações éster de fosfatos orgânicos, liberando P disponível.
                            </p>
                            <ul class="text-sm space-y-2 text-stone-700 border-l-2 border-amber-200 pl-3">
                                <li class="flex items-start">
                                    <span class="text-amber-500 mr-2 font-bold">1.</span> 
                                    <span><strong>Incubação:</strong> O sobrenadante é incubado com a solução de p-NPP tamponada.</span>
                                </li>
                                <li class="flex items-start">
                                    <span class="text-amber-500 mr-2 font-bold">2.</span> 
                                    <span><strong>Clivagem:</strong> A enzima hidrolisa o p-NPP (que é incolor).</span>
                                </li>
                                <li class="flex items-start">
                                    <span class="text-amber-500 mr-2 font-bold">3.</span> 
                                    <span><strong>Cor:</strong> Liberação de p-Nitrofenol, que apresenta cor <strong class="text-amber-600">AMARELA</strong> em meio alcalino.</span>
                                </li>
                            </ul>
                            <p class="text-xs text-stone-500 mt-4 italic bg-stone-50 p-2 rounded"><strong>Referência:</strong> Tabatabai, M. A., & Bremner, J. M. (1969). "Use of p-nitrophenyl phosphate for assay of soil phosphatase activity."</p>
                        </div>
                        
                        <!-- VISUAL DIAGRAM RESTORED -->
                        <div class="flex-1 flex flex-col items-center justify-center bg-stone-50 rounded p-4 border border-stone-100">
                            <div class="flex items-center gap-6">
                                <!-- Negative Tube -->
                                <div class="flex flex-col items-center group">
                                    <div class="w-12 h-24 border-2 border-stone-300 rounded-b-xl bg-white relative overflow-hidden shadow-sm">
                                        <div class="absolute bottom-0 w-full h-16 bg-blue-50/30"></div>
                                    </div>
                                    <span class="text-xs text-stone-500 mt-2 font-semibold">Controle (-)</span>
                                    <span class="text-[10px] text-stone-400">Incolor</span>
                                </div>
                                
                                <span class="text-2xl text-stone-300">&#10142;</span>
                                
                                <!-- Positive Tube -->
                                <div class="flex flex-col items-center group">
                                    <div class="w-12 h-24 border-2 border-amber-300 rounded-b-xl bg-white relative overflow-hidden shadow-md">
                                        <div class="absolute bottom-0 w-full h-16 bg-yellow-300/80 transition-all duration-500 group-hover:h-20"></div>
                                    </div>
                                    <span class="text-xs text-amber-800 mt-2 font-semibold">Positivo (+)</span>
                                    <span class="text-[10px] text-amber-600">Amarelo Intenso</span>
                                </div>
                            </div>
                            <p class="text-xs text-center mt-4 text-stone-500 bg-white px-3 py-1 rounded border border-stone-200 shadow-sm">
                                Leitura em Espectrofotômetro: <strong>405 - 420 nm</strong>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

             <!-- Analytical Methods -->
             <div>
                <h3 class="text-lg font-bold text-stone-800 mb-4 flex items-center">
                    3. Métodos Analíticos de Quantificação
                    <span class="ml-2 text-xs font-normal bg-stone-100 px-2 py-1 rounded text-stone-500">Padrão Ouro</span>
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Phosphorus (P) -->
                    <div class="bg-white p-5 rounded-lg shadow-sm border-t-4 border-blue-500 border-x border-b border-stone-200">
                        <h4 class="font-bold text-stone-800">Fósforo (P)</h4>
                        <div class="space-y-4 mt-2">
                            <div>
                                <h5 class="text-xs font-bold text-stone-700 uppercase mb-1">Azul de Molibdênio</h5>
                                <p class="text-xs text-stone-600">Leitura a <strong>880 nm</strong>.</p>
                                <p class="text-[10px] text-stone-400 italic">Ref: Murphy, J. & Riley, J.P. (1962).</p>
                            </div>
                            <div class="border-t border-stone-100 pt-2">
                                <h5 class="text-xs font-bold text-stone-700 uppercase mb-1">Vanadomolibdato</h5>
                                <p class="text-xs text-stone-600">Leitura a <strong>420-470 nm</strong>.</p>
                                <p class="text-[10px] text-stone-400 italic">Ref: Hanson, W. C. (1950).</p>
                            </div>
                        </div>
                    </div>
                    <!-- Potassium (K) -->
                    <div class="bg-white p-5 rounded-lg shadow-sm border-t-4 border-purple-500 border-x border-b border-stone-200">
                        <h4 class="font-bold text-stone-800">Potássio (K)</h4>
                        <div class="space-y-4 mt-2">
                            <div>
                                <h5 class="text-xs font-bold text-stone-700 uppercase mb-1">Fotometria de Chama</h5>
                                <p class="text-xs text-stone-600">Emissão atômica a <strong>766 nm</strong>.</p>
                                <p class="text-[10px] text-stone-400 italic">Ref: Standard Methods (APHA).</p>
                            </div>
                        </div>
                    </div>
                    <!-- Ca & Mg -->
                    <div class="bg-white p-5 rounded-lg shadow-sm border-t-4 border-orange-500 border-x border-b border-stone-200">
                        <h4 class="font-bold text-stone-800">Cálcio & Magnésio</h4>
                        <div class="space-y-4 mt-2">
                            <div>
                                <h5 class="text-xs font-bold text-stone-700 uppercase mb-1">Titulação Complexométrica</h5>
                                <p class="text-xs text-stone-600">Uso de <strong>EDTA</strong>.</p>
                                <p class="text-[10px] text-stone-400 italic">Ref: Standard Methods (APHA) / Embrapa.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. BIOCHEMISTRY SECTION (REFACTORED CLEAN) -->
        <div id="bio" class="content-section hidden space-y-6 animate-fade-in">
             <div class="flex flex-col gap-6">
                
                <!-- Main Header for this section -->
                <div class="bg-stone-800 text-white p-6 rounded-lg shadow-md border-l-8 border-amber-500">
                    <h3 class="text-xl font-bold flex items-center gap-3">
                        <span class="text-3xl">&#9881;</span> Perfil de Ácidos Orgânicos
                    </h3>
                    <p class="text-sm text-stone-300 mt-2">
                        Metodologia avançada para identificação qualitativa e quantitativa dos ácidos orgânicos produzidos (mecanismo central de acidólise).
                    </p>
                </div>

                <!-- Detailed Protocol Card (CE) -->
                <div class="bg-white rounded-lg shadow-lg border border-stone-200 overflow-hidden">
                    <div class="bg-amber-50 p-4 border-b border-amber-100 flex justify-between items-center">
                        <h4 class="font-bold text-amber-900 text-lg">Protocolo de Eletroforese Capilar (CE)</h4>
                        <span class="text-xs font-mono text-amber-700 bg-amber-100 px-2 py-1 rounded">Equipamento: Agilent 7100</span>
                    </div>
                    
                    <div class="p-8">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            
                            <!-- Left Column: System & Conditions -->
                            <div class="space-y-6">
                                <div>
                                    <h5 class="text-sm font-bold text-stone-500 uppercase tracking-wide border-b border-stone-200 pb-2 mb-3">Sistema Analítico</h5>
                                    <ul class="space-y-2 text-sm text-stone-700">
                                        <li class="flex justify-between">
                                            <span class="font-semibold">Detector:</span>
                                            <span>DAD (Arranjo de Diodos)</span>
                                        </li>
                                        <li class="flex justify-between">
                                            <span class="font-semibold">Capilar:</span>
                                            <span>Sílica fundida (não revestido)</span>
                                        </li>
                                        <li class="flex justify-between">
                                            <span class="font-semibold">Dimensões:</span>
                                            <span>L: 60.5 cm | DI: 75 µm</span>
                                        </li>
                                        <li class="flex justify-between">
                                            <span class="font-semibold">Temperatura:</span>
                                            <span>20 °C (Cassete)</span>
                                        </li>
                                    </ul>
                                </div>

                                <div>
                                    <h5 class="text-sm font-bold text-stone-500 uppercase tracking-wide border-b border-stone-200 pb-2 mb-3">Condições de Separação</h5>
                                    <ul class="space-y-2 text-sm text-stone-700">
                                        <li class="flex justify-between">
                                            <span class="font-semibold">Injeção:</span>
                                            <span>Hidrodinâmica (50 mbar / 3 s)</span>
                                        </li>
                                        <li class="flex justify-between">
                                            <span class="font-semibold">Voltagem:</span>
                                            <span>-15 kV (Polaridade Invertida)</span>
                                        </li>
                                        <li class="flex justify-between">
                                            <span class="font-semibold">Detecção (UV):</span>
                                            <span class="text-right">Sinal: 230 nm (Indireto)<br><span class="text-xs text-stone-400">Ref: 360 nm</span></span>
                                        </li>
                                    </ul>
                                </div>
                            </div>

                            <!-- Right Column: Chemistry & Analytes -->
                            <div class="space-y-6">
                                <div>
                                    <h5 class="text-sm font-bold text-stone-500 uppercase tracking-wide border-b border-stone-200 pb-2 mb-3">Química (BGE & Preparo)</h5>
                                    
                                    <div class="bg-stone-50 p-3 rounded-lg border border-stone-200 mb-3">
                                        <strong class="block text-stone-800 mb-1 text-sm">Eletrólito de Corrida (BGE) pH 3.3:</strong>
                                        <ul class="text-xs text-stone-600 list-disc list-inside">
                                            <li>Ácido Ftálico (20 mM)</li>
                                            <li>Tris (14 mM)</li>
                                            <li>CTAB (1.6 mM) - Modificador de fluxo</li>
                                            <li>CaCl₂ (1 mM)</li>
                                        </ul>
                                    </div>

                                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                                        <strong class="block text-blue-900 mb-1 text-sm">Padrão Interno (PI):</strong>
                                        <p class="text-xs text-blue-800">
                                            Ácido Glioxílico (14.8 mg/L).<br>
                                            <strong>Adição:</strong> 9 partes de amostra : 1 parte de PI.
                                        </p>
                                    </div>
                                </div>

                                <div>
                                    <h5 class="text-sm font-bold text-stone-500 uppercase tracking-wide border-b border-stone-200 pb-2 mb-3">Analitos Quantificados</h5>
                                    <div class="flex flex-wrap gap-2">
                                        <span class="px-2 py-1 bg-stone-100 text-stone-600 rounded text-xs border border-stone-200">Acético</span>
                                        <span class="px-2 py-1 bg-amber-100 text-amber-800 rounded text-xs border border-amber-200 font-bold">Cítrico</span>
                                        <span class="px-2 py-1 bg-stone-100 text-stone-600 rounded text-xs border border-stone-200">Fórmico</span>
                                        <span class="px-2 py-1 bg-stone-100 text-stone-600 rounded text-xs border border-stone-200">Fumárico</span>
                                        <span class="px-2 py-1 bg-amber-100 text-amber-800 rounded text-xs border border-amber-200 font-bold">Glucônico</span>
                                        <span class="px-2 py-1 bg-stone-100 text-stone-600 rounded text-xs border border-stone-200">Lático</span>
                                        <span class="px-2 py-1 bg-stone-100 text-stone-600 rounded text-xs border border-stone-200">Málico</span>
                                        <span class="px-2 py-1 bg-stone-100 text-stone-600 rounded text-xs border border-stone-200">Maleico</span>
                                        <span class="px-2 py-1 bg-stone-100 text-stone-600 rounded text-xs border border-stone-200">Malônico</span>
                                        <span class="px-2 py-1 bg-amber-100 text-amber-800 rounded text-xs border border-amber-200 font-bold">Oxálico</span>
                                        <span class="px-2 py-1 bg-stone-100 text-stone-600 rounded text-xs border border-stone-200">Propiônico</span>
                                        <span class="px-2 py-1 bg-stone-100 text-stone-600 rounded text-xs border border-stone-200">Succínico</span>
                                        <span class="px-2 py-1 bg-stone-100 text-stone-600 rounded text-xs border border-stone-200">Tartárico</span>
                                    </div>
                                    <p class="text-[10px] text-stone-400 mt-2 italic">*Ácidos em destaque (âmbar) são quelantes fortes.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Beer-Lambert Calculator -->
                    <div class="bg-stone-100 text-stone-800 p-6 rounded-lg border border-stone-200 mt-4">
                        <h3 class="font-bold mb-3 flex items-center gap-2 text-sm">
                            <span>&#128200;</span> Calculadora: Absorbância &#8594; Concentração
                        </h3>
                        <div class="space-y-3">
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-stone-500">Inclinação (a)</label>
                                    <input type="number" id="slopeA" class="w-full bg-white border border-stone-300 rounded p-1 text-sm" placeholder="Ex: 0.045">
                                </div>
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-stone-500">Intercepto (b)</label>
                                    <input type="number" id="interceptB" class="w-full bg-white border border-stone-300 rounded p-1 text-sm" placeholder="Ex: 0.002">
                                </div>
                            </div>
                            <div>
                                <label class="text-[10px] uppercase font-bold text-stone-500">Absorbância Lida (y)</label>
                                <input type="number" id="absY" class="w-full bg-white border border-stone-300 rounded p-1 text-sm" placeholder="Ex: 0.540">
                            </div>
                            <button onclick="calculateConcentration()" class="w-full bg-stone-700 hover:bg-stone-800 text-white py-1 rounded text-sm font-bold transition">Calcular</button>
                            <div id="concResult" class="text-center font-mono text-xl mt-2 text-stone-600">-- mg/L</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 5. MOLECULAR SECTION -->
        <div id="mol" class="content-section hidden space-y-6 animate-fade-in">
             <div class="bg-white p-6 rounded-lg shadow-sm border border-stone-200">
                <h3 class="text-xl font-bold text-stone-800 mb-4">Identificação Molecular</h3>
                
                <h4 class="font-semibold text-stone-700 mb-2 border-l-4 border-stone-400 pl-2">Genotipagem (Taxonomia)</h4>
                <div class="overflow-x-auto mb-8">
                    <table class="min-w-full text-sm text-left text-stone-600">
                        <thead class="text-xs text-stone-700 uppercase bg-stone-50">
                            <tr><th class="px-6 py-3">Grupo</th><th class="px-6 py-3">Gene Alvo</th><th class="px-6 py-3">Primers Universais</th><th class="px-6 py-3">Referência</th></tr>
                        </thead>
                        <tbody>
                            <tr class="bg-white border-b hover:bg-stone-50">
                                <td class="px-6 py-4 font-medium text-stone-900">Bactérias</td>
                                <td class="px-6 py-4">16S rRNA</td>
                                <td class="px-6 py-4 font-mono text-xs">27F / 1492R</td>
                                <td class="px-6 py-4 text-xs italic">Weisburg et al. (1991)</td>
                            </tr>
                            <tr class="bg-white hover:bg-stone-50">
                                <td class="px-6 py-4 font-medium text-stone-900">Fungos</td>
                                <td class="px-6 py-4">Região ITS</td>
                                <td class="px-6 py-4 font-mono text-xs">ITS1 / ITS4</td>
                                <td class="px-6 py-4 text-xs italic">White et al. (1990)</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="bg-blue-50 border border-blue-100 p-6 rounded-lg mb-8">
                    <h4 class="font-bold text-blue-900 mb-2">Busca por Genes Funcionais (Solubilização)</h4>
                    <p class="text-sm text-blue-800 mb-4">
                        Para identificar o potencial genético, recomenda-se a amplificação de genes específicos:
                    </p>
                    <ul class="text-sm space-y-2 text-blue-800">
                        <li><strong>Fosfatase Alcalina (<em>phoD</em>):</strong> Primers ALPS (Ref: Sakurai et al., 2008).</li>
                        <li><strong>Fitases (<em>phy</em>):</strong> Para Bacillus (BPP-F/R) ou fungos (<em>phyA</em>).</li>
                        <li><strong>Glicose Desidrogenase (<em>gcd</em>):</strong> Marcador de produção de ácido glucônico.</li>
                    </ul>
                </div>

                <!-- Process Steps -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="p-6 bg-stone-50 rounded border border-stone-100 text-center hover:shadow-md transition">
                        <div class="text-2xl mb-2">&#129514;</div>
                        <h5 class="font-bold text-stone-800">1. Extração de DNA</h5>
                        <p class="text-xs text-stone-600 mt-2">Isolamento do material genético.</p>
                        <hr class="my-2 border-stone-200">
                        <p class="text-[10px] text-stone-500">Método Fenol-Clorofórmio ou Kits Comerciais (Coluna de Sílica).</p>
                    </div>
                    <div class="p-6 bg-stone-50 rounded border border-stone-100 text-center hover:shadow-md transition">
                        <div class="text-2xl mb-2">&#9881;</div>
                        <h5 class="font-bold text-stone-800">2. Amplificação (PCR)</h5>
                        <p class="text-xs text-stone-600 mt-2">Multiplicação da região alvo.</p>
                        <hr class="my-2 border-stone-200">
                        <p class="text-[10px] text-stone-500">Mix 25µL: Tampão, dNTPs, Primers (0.4µM), Taq Pol, DNA Molde.</p>
                    </div>
                    <div class="p-6 bg-stone-50 rounded border border-stone-100 text-center hover:shadow-md transition">
                        <div class="text-2xl mb-2">&#128187;</div>
                        <h5 class="font-bold text-stone-800">3. Sequenciamento</h5>
                        <p class="text-xs text-stone-600 mt-2">Leitura da sequência de bases.</p>
                        <hr class="my-2 border-stone-200">
                        <p class="text-[10px] text-stone-500">Sanger (padrão ouro) -> Edição no BioEdit -> Comparação no BLAST (NCBI).</p>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- RESOURCES MODAL -->
    <div id="resourcesModal" class="modal hidden fixed inset-0 bg-stone-900 bg-opacity-70 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] flex flex-col">
            <div class="p-6 border-b border-stone-100 flex justify-between items-center bg-stone-50 rounded-t-xl">
                <h3 class="text-xl font-bold text-stone-800 flex items-center gap-2"><span>&#128230;</span> Materiais Essenciais</h3>
                <button onclick="toggleModal()" class="text-stone-400 hover:text-stone-700 text-2xl font-bold">&times;</button>
            </div>
            <div class="p-8 overflow-y-auto custom-scrollbar">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-4">
                        <h4 class="font-bold text-stone-700 border-l-4 border-amber-500 pl-3 uppercase text-sm tracking-wide">Equipamentos Laboratoriais</h4>
                        <ul class="space-y-2 text-sm text-stone-600">
                            <!-- UPDATED -->
                            <li class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-amber-400"></span> <strong>Inoculador de Steers:</strong> Para triagem massiva multiponto.</li>
                            <!-- ADDED: BOD -->
                            <li class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-amber-400"></span> <strong>Incubadora B.O.D.:</strong> Crescimento controlado (28-30°C).</li>
                            <li class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-amber-400"></span> <strong>Autoclave:</strong> Esterilização de meios (121°C/15min).</li>
                            <li class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-amber-400"></span> <strong>Capela de Fluxo Laminar:</strong> Manipulação asséptica.</li>
                            <li class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-amber-400"></span> <strong>Shaker (Orbital):</strong> Para ensaios líquidos (150rpm).</li>
                            <li class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-amber-400"></span> <strong>Espectrofotômetro:</strong> Leituras de absorbância.</li>
                        </ul>
                    </div>
                    <div class="space-y-4">
                        <h4 class="font-bold text-stone-700 border-l-4 border-blue-500 pl-3 uppercase text-sm tracking-wide">Vidrarias & Consumíveis</h4>
                        <ul class="space-y-2 text-sm text-stone-600">
                            <li class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-blue-400"></span> <strong>Placas de Petri:</strong> 90mm, estéreis.</li>
                            <li class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-blue-400"></span> <strong>Erlenmeyers:</strong> Para ensaios líquidos.</li>
                            <li class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-blue-400"></span> <strong>Filtros:</strong> Membrana 0.45µm.</li>
                        </ul>
                    </div>
                    <div class="space-y-4">
                        <h4 class="font-bold text-stone-700 border-l-4 border-purple-500 pl-3 uppercase text-sm tracking-wide">Reagentes Chave</h4>
                        <ul class="space-y-2 text-sm text-stone-600">
                            <li class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-purple-400"></span> <strong>Fontes Insolúveis:</strong> Fosfato Tricálcico, Mica, Feldspato.</li>
                            <li class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-purple-400"></span> <strong>Meios:</strong> Agar, Glicose, Extrato de Levedura.</li>
                            <li class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-purple-400"></span> <strong>Indicadores:</strong> Azul de Bromotimol.</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t border-stone-100 bg-stone-50 flex justify-end rounded-b-xl">
                <button onclick="toggleModal()" class="px-6 py-2 bg-stone-800 text-white rounded hover:bg-stone-900 transition text-sm font-semibold">Fechar</button>
            </div>
        </div>
    </div>

    <script>
        // State Management
        const state = {
            currentTab: 'dashboard',
            currentChart: null,
            doughnutChart: null
        };

        const mediaProtocols = [
            { id: 1, name: "Meio NBRIP", nutrient: "P", source: "Fosfato de Ca/Fe/Al", ingredients: ["Glicose (10g)", "Fosfato tricálcico (5g)", "MgCl2.6H2O (5g)", "MgSO4.7H2O (0.25g)", "KCl (0.2g)", "(NH4)2SO4 (0.1g)", "Agar (15g)"], citation: "Ref: Nautiyal, C. S. (1999).", notes: "Padrão ouro para P." },
            { id: 2, name: "Meio Pikovskaya (PVK)", nutrient: "P", source: "Fosfato Tricálcico", ingredients: ["Glicose (10g)", "Fosfato tricálcico (5g)", "(NH4)2SO4 (0.5g)", "NaCl (0.2g)", "MgSO4.7H2O (0.1g)", "KCl (0.2g)", "Extrato de levedura (0.5g)", "Agar (15g)"], citation: "Ref: Pikovskaya, R. I. (1948).", notes: "Risco de falso positivo (extrato de levedura)." },
            { id: 3, name: "Meio Alexandrov Modificado", nutrient: "K", source: "Mica / Feldspato", ingredients: ["Glicose (5g)", "Mica em pó (2g)", "MgSO4.7H2O (0.5g)", "CaCO3 (0.1g)", "FeCl3 (0.006g)", "Agar (15g)"], citation: "Ref: Alexandrov et al. (1967).", notes: "Usar com indicador de pH." },
            { id: 4, name: "Meio Bunt & Rovira", nutrient: "CaMg", source: "Carbonato de Ca/Mg", ingredients: ["Glicose (20g)", "Peptona (1g)", "Extrato de levedura (1g)", "Solo (extrato)", "Fonte Insolúvel (0.5%)", "Agar (15g)"], citation: "Ref: Bunt, J. S., & Rovira, A. D. (1955).", notes: "Meio rico." },
            // NEW MEDIUM ADDED
            { id: 5, name: "Meio Diferencial CDB (Calcite)", nutrient: "CaMg", source: "Carbonato de Ca/Mg", ingredients: ["Glicose (5g)", "Yeast Extract (1g)", "Peptona (1g)", "K2HPO4 (0.4g)", "MgSO4 (0.01g)", "NaCl (5g)", "(NH4)2SO4 (0.05g)", "Carbonato (5g)", "Agar (7.5g)"], citation: "Ref: Peper et al. (2022). Frontiers in Microbiomes.", notes: "Específico para Calcite Dissolving Bacteria." }
        ];

        const kineticsData = {
            P: { labels: ['0', '3', '5', '7', '10', '14'], solubilization: [0, 45, 120, 210, 280, 260], ph: [7.0, 6.2, 5.1, 4.2, 3.8, 4.0] },
            K: { labels: ['0', '3', '5', '7', '10', '14'], solubilization: [0, 10, 25, 40, 55, 60], ph: [7.0, 6.5, 5.8, 5.2, 4.8, 4.9] }
        };

        // Initialization
        document.addEventListener('DOMContentLoaded', () => {
            initDashboardCharts();
            renderMediaCards('all');
            updatePetriViz(); 
        });

        // Modal Logic
        function toggleModal() {
            const modal = document.getElementById('resourcesModal');
            const body = document.body;
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                setTimeout(() => { modal.classList.remove('opacity-0'); modal.classList.add('opacity-100'); }, 10);
                body.classList.add('modal-active');
            } else {
                modal.classList.remove('opacity-100'); modal.classList.add('opacity-0');
                setTimeout(() => { modal.classList.add('hidden'); }, 250);
                body.classList.remove('modal-active');
            }
        }

        function switchTab(tabId) {
            document.querySelectorAll('.content-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active-nav'));
            document.getElementById(`nav-${tabId}`).classList.add('active-nav');
            
            const titles = { 'dashboard': 'Visão Geral', 'micro': 'Triagem Microbiológica', 'colorim': 'Testes Analíticos & Colorimétricos', 'bio': 'Bioquímica e Quantificação', 'mol': 'Identificação Molecular' };
            document.getElementById('page-title').innerText = titles[tabId];

            if(tabId === 'dashboard') initDashboardCharts();
            // if(tabId === 'bio') initKineticsChart('P'); // Removed per request
            if(tabId === 'micro') updatePetriViz(); 
        }

        // --- Concentration Calculator ---
        function calculateConcentration() {
            const a = parseFloat(document.getElementById('slopeA').value);
            const b = parseFloat(document.getElementById('interceptB').value);
            const y = parseFloat(document.getElementById('absY').value);
            const resultDiv = document.getElementById('concResult');

            if (isNaN(a) || isNaN(b) || isNaN(y)) {
                resultDiv.innerText = "Erro";
                return;
            }
            const x = (y - b) / a;
            resultDiv.innerText = x.toFixed(2) + " mg/L";
        }

        // --- Petri Viz & IS Calc ---
        function updatePetriViz() {
            const canvas = document.getElementById('petriCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            
            const colInput = parseFloat(document.getElementById('colonyDiam').value) || 0;
            const haloInput = parseFloat(document.getElementById('haloDiam').value) || 0;
            const width = canvas.width;
            const height = canvas.height;
            const centerX = width / 2;
            const centerY = height / 2;

            ctx.clearRect(0, 0, width, height);
            ctx.beginPath();
            ctx.arc(centerX, centerY, 140, 0, 2 * Math.PI);
            ctx.fillStyle = '#fef3c7'; 
            ctx.fill();
            ctx.strokeStyle = '#d6d3d1';
            ctx.lineWidth = 4;
            ctx.stroke();

            const scale = 4; 
            const haloRadius = (haloInput / 2) * scale;
            const colRadius = (colInput / 2) * scale;

            if (haloInput > 0) {
                ctx.beginPath();
                ctx.arc(centerX, centerY, haloRadius, 0, 2 * Math.PI);
                ctx.fillStyle = 'rgba(251, 191, 36, 0.4)'; 
                ctx.fill();
                ctx.strokeStyle = '#d97706'; 
                ctx.lineWidth = 1;
                ctx.stroke();
                
                ctx.fillStyle = '#92400e';
                ctx.font = '10px Inter';
                ctx.fillText(`Halo: ${haloInput}mm`, centerX + haloRadius + 5, centerY);
            }

            if (colInput > 0) {
                ctx.beginPath();
                ctx.arc(centerX, centerY, colRadius, 0, 2 * Math.PI);
                ctx.fillStyle = '#ffffff';
                ctx.fill();
                ctx.strokeStyle = '#a8a29e';
                ctx.lineWidth = 1;
                ctx.stroke();

                ctx.fillStyle = '#44403c';
                ctx.fillText(`Colônia: ${colInput}mm`, centerX - 20, centerY + colRadius + 15);
            }
            calculateSI(colInput, haloInput);
        }

        function calculateSI(col, halo) {
            const resultDiv = document.getElementById('siValue');
            const classDiv = document.getElementById('siClass');
            const box = document.getElementById('siResultBox');

            if (!col || col <= 0 || !halo) {
                resultDiv.innerText = "--";
                classDiv.innerText = "Dados incompletos";
                box.className = "mt-6 p-4 rounded-lg bg-stone-50 text-center border border-stone-200";
                return;
            }
            if (halo < col) {
                 resultDiv.innerText = "Erro";
                 classDiv.innerText = "Halo < Colônia?";
                 box.className = "mt-6 p-4 rounded-lg bg-red-50 text-center border border-red-200 text-red-800";
                 return;
            }
            const si = halo / col;
            let classification = "", colorClass = "";

            if (si < 2) { classification = "Baixa Eficiência (IS < 2)"; colorClass = "bg-stone-100 border-stone-300 text-stone-600"; }
            else if (si < 3) { classification = "Média Eficiência (2 ≤ IS < 3)"; colorClass = "bg-yellow-50 border-yellow-300 text-yellow-800"; }
            else { classification = "Alta Eficiência (IS ≥ 3)"; colorClass = "bg-green-50 border-green-300 text-green-800"; }

            resultDiv.innerText = si.toFixed(2);
            classDiv.innerText = classification;
            box.className = `mt-6 p-4 rounded-lg text-center border transition-all ${colorClass}`;
        }

        // Logic: Media Cards
        function renderMediaCards(filter) {
            const grid = document.getElementById('media-grid');
            grid.innerHTML = '';
            const filtered = filter === 'all' ? mediaProtocols : mediaProtocols.filter(m => filter === 'CaMg' ? (m.nutrient === 'Ca' || m.nutrient === 'CaMg') : m.nutrient === filter);

            filtered.forEach(m => {
                const card = document.createElement('div');
                card.className = 'bg-white p-5 rounded-lg border border-stone-200 shadow-sm card-hover cursor-pointer transition-all duration-300';
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-bold text-stone-800">${m.name}</h4>
                        <span class="px-2 py-1 text-xs font-bold rounded ${getBadgeColor(m.nutrient)}">${m.nutrient}</span>
                    </div>
                    <p class="text-xs text-stone-500 mb-2"><strong>Fonte:</strong> ${m.source}</p>
                    <p class="text-[10px] text-stone-400 font-mono mb-3 bg-stone-50 inline-block px-1 rounded">${m.citation}</p>
                    <div class="details-content text-sm text-stone-600 bg-stone-50 p-3 rounded mt-2">
                        <p class="font-semibold mb-1 text-xs">Ingredientes:</p>
                        <ul class="list-disc list-inside mb-2 text-xs">
                            ${m.ingredients.map(i => `<li>${i}</li>`).join('')}
                        </ul>
                        <p class="italic text-xs border-t border-stone-200 pt-1 mt-1">${m.notes}</p>
                    </div>
                `;
                grid.appendChild(card);
            });
        }
        function filterMedia(type) { renderMediaCards(type); }
        function getBadgeColor(n) {
            if(n==='P') return 'bg-blue-100 text-blue-800';
            if(n==='K') return 'bg-purple-100 text-purple-800';
            return 'bg-orange-100 text-orange-800';
        }

        // Charts
        function initDashboardCharts() {
            const ctx = document.getElementById('mechanismsChart');
            if(!ctx) return;
            if(state.doughnutChart) state.doughnutChart.destroy();
            state.doughnutChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Acidólise', 'Troca H+', 'Quelação', 'Enzimático'],
                    datasets: [{ data: [50, 20, 15, 15], backgroundColor: ['#d97706', '#f59e0b', '#78716c', '#57534e'], borderWidth: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        }

    </script>
</body>
</html>
